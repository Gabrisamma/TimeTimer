<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
        
        <link rel="shortcut icon" href="#">
        <link rel="stylesheet" href="static/css/styles.css">
        
        <title>TimeTimer</title>
    </head>
    <body>
        <div class="lefthalf-screen">
            <div class="timer-container">
                <div class="clock">
                    <img src="static/images/ios_clock.svg" alt="Timer" class="clock-image">
                    <div class="clock-background">
                        <div class="mask-left" id="mask-left"></div>
                        <div class="mask-right" id="mask-right"></div>
                        <div class="mark-hand" id="mark-hand"></div>
                    </div>
                    <div class="center-circle"></div>
                </div>
            </div>

            <div class="form-container">
                <form id="formTimer" action="/datapost" method="post">
                    <div class="inputs-form">
                        <div class="input-group input-group-lg">
                            <label for="time-input" class="input-group-text">Tempo</label>
                            <input type="number" id="time-input" class="time-input form-control" value=30 min=1 max=60>
                        </div>
                        
                        <div class="input-group input-group-lg">
                            <label for="tag-input" class="input-group-text">Tag</label>
                            <input type="text" id="tag-input" class="form-control">
                        </div>

                        <input type="hidden" id ="remaining-time">
                    </div>
                    
                    <div class="buttons-form">
                        <button id="start-timer" type="button" class="btn btn-primary" onclick="loadTimer()">Inizia Timer</button>
                        <button type="submit" id="submit-time" class="btn btn-danger">Stop</button>
                    </div>
                </form>
            </div>
        </div>


        <table id="history-table" class="table table-striped table-history">
            <thead>
                <th>Tempo Inserito</th>
                <th>Tempo Rimanente</th>
                <th>Tag</th>
            </thead>
            
            <tbody class="table-body">

            </tbody>
        </table>

        <!--<form action="/deleteAll">
            <button class="btn btn-danger">Delete</button>
        </form>-->

        <div>
            <h1 id="cd"></h1>
            <button onclick="ReloadData()" aria-label="Reload Button"><img class="reload-button" src="/static/images/reload.jpg" alt="reload"></button>
        </div>
    </body>


    <script>
        var remainingTime;


        $(window).on('load', function() {
            makeCorsRequest('/dataget');
        });

        
        function loadTimer() {
            remainingTime = $('#time-input').val() * 60;

            var left_mask = document.getElementById("mask-left");
            var right_mask = document.getElementById("mask-right");
            var mark_hand = document.getElementById("mark-hand");

            var funcid = setInterval(moveTimer, 1000);

            
            function moveTimer() {
                if (remainingTime <= 0) { 
                    right_mask.style.transform = "rotate(180deg)";
                    clearInterval(funcid);
                }
                if (remainingTime <= 1800) {
                    var leftRotation = (180 - (180 / (1800 / remainingTime)));
                    left_mask.style.transform = "rotate(" + leftRotation + "deg)";
                    right_mask.style.backgroundColor = "white";
                    right_mask.style.transform = "rotate(0deg)"
                    mark_hand.style.transform = "rotate(" + leftRotation + "deg)"; 
                } else {
                    var rightRotation = (360 - (360 / (3600 / remainingTime)));
                    left_mask.style.transform = "rotate(0deg)"
                    right_mask.style.backgroundColor = "red";
                    right_mask.style.transform = "rotate(" + rightRotation + "deg)";
                    mark_hand.style.transform = "rotate(" + (rightRotation - 180) + "deg)";
                }
                
                remainingTime -= 1;
            }
            
        }


        function ReloadData() {
            makeCorsRequest('/dataget');
        }


        $("#formTimer").submit(function(e) {

            e.preventDefault();

            var form = $(this);

            $("#remaining-time").val(remainingTime);

            makeCorsPost(form);

        });


        // Create the XHR object.
        function createCORSRequest(method, url) {
            var xhr = new XMLHttpRequest();
            if ("withCredentials" in xhr) {
                // XHR for Chrome/Firefox/Opera/Safari.
                xhr.open(method, url, true);
            } else if (typeof XDomainRequest != "undefined") {
                // XDomainRequest for IE.
                xhr = new XDomainRequest();
                xhr.open(method, url);
            } else {
                // CORS not supported.
                xhr = null;
            }
            return xhr;
        }


        // Function to get data from the form, to call just befor starting the POST HTTP call
        function getJsonForm(form){

            // taking all input values of the element with id eventsform and serilizing them using the JQUERY serializeArray function
            var jsonform = $("#" + form.attr('id') + " input").toArray();

            // redefine the structure the data obtained from the form

            jsondata = new Object;
            for (i=0; i<jsonform.length; i++) {
                key = jsonform[i].id;
                val = jsonform[i].value;
                jsondata[key] = val;
            }

            //Convert the Object in a string befor using it in the HTTP call
            return JSON.stringify(jsondata);
        }


        // function to POST data on the DB
        function makeCorsPost(form) {

            // call the function returning data from the form
            var jsondata = getJsonForm(form);

            var xhr = createCORSRequest('POST', form.attr('action'));
            if (!xhr) {
                alert('CORS not supported');
                return;
            }

            // Response handlers.
            xhr.onload = function() {
                var status = xhr.status;
                console.log("makeCorsPost: " + status);
            }

            xhr.onerror = function() {
                alert('Woops, there was an error making the request.');
            };

            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(jsondata);

        }

        
        
        
        // Function to get data from the DB
        function makeCorsRequest(url) {

            var xhr = createCORSRequest('GET', url);
            if (!xhr) {
                alert('CORS not supported');
                return;
            }

            // Response handlers.
            xhr.onload = function() {
                var rq = xhr.responseText;
                var result = JSON.parse(rq);
                var status = xhr.status;
                console.log("makeCorsRequest: " + status);

                console.log(result);
                
                populateHistory(result);

            };

            xhr.onerror = function() {
                alert('Woops, there was an error making the request.');
            };

            xhr.send();
        }


        function populateHistory(jsondata) {
            var table = document.getElementById('history-table').getElementsByTagName('tbody')[0];

            jsondata.reverse().forEach(function(element) {
                console.log(element);
                const newRow = table.insertRow();

                const totalColumn = newRow.insertCell(-1);
                totalColumn.innerHTML = secondsToMinutes(parseInt(element['totalTime']));

                const remainingColumn = newRow.insertCell(-1);
                remainingColumn.innerHTML = secondsToMinutes(parseInt(element['remainingTime']));

                const tagColumn = newRow.insertCell(-1);
                tagColumn.innerHTML = element['tag'];
            })  
        }


        function secondsToMinutes(seconds) {
            var minutes = Math.floor(seconds / 60);
            var seconds = seconds - (minutes * 60);

            seconds = seconds > 9 ? "" + seconds : "0" + seconds;

            return minutes + ":" + seconds;
        }


    </script>
</html>